console.log("Tabemap: Content script loaded");let i=null;const p=new MutationObserver(e=>{f()});function f(){const e=document.querySelectorAll("h1");let n=null,t=null;for(const o of e){const a=o.textContent?.trim();if(a&&a!=="Results"&&a!=="Google Maps"&&a!=="Tabemap"&&o.offsetParent!==null){n=o,t=a;break}}if(!n||!t)return;const r=document.querySelectorAll("h2");let l=null;const s=/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/;for(const o of r){const a=o.querySelector("span");if(a&&a.textContent&&s.test(a.textContent)){l=a.textContent.trim();break}if(o.textContent&&s.test(o.textContent)){l=o.textContent.trim();break}}if(l&&(console.log("Found Japanese name:",l),t=l),i===t){d(n);return}console.log("Found place (final):",t),i=t;let c=null;const u=document.querySelector('button[aria-label^="Phone:"], button[aria-label^="電話:"]');if(u){const o=u.getAttribute("aria-label");if(o){const a=o.match(/(\d[\d-]+\d)/);a&&(c=a[1])}}console.log("Extracted phone:",c),browser.runtime.sendMessage({type:"FETCH_TABELOG",payload:{name:t,phone:c}}),d(n)}function d(e){if(e.parentElement?.querySelector(".tabemap-rating-container"))return;const n=document.createElement("div");n.className="tabemap-rating-container",n.innerHTML=`
        <span class="tabemap-rating-badge tabemap-rating-mid">
            Loading...
        </span>
    `,e.parentElement&&e.parentElement.appendChild(n)}browser.runtime.onMessage.addListener(e=>{if(e.type==="TABELOG_DATA"){const{rating:n,url:t,name:r}=e.payload;console.log("Received TABELOG_DATA:",e.payload),console.log("Current Identifier:",i),i===r?m(n,t):console.warn("Name mismatch, ignoring update.")}else if(e.type==="TABELOG_ERROR"){const{name:n,error:t}=e.payload;console.error("Tabemap Error:",t),i===n&&m(null,null)}else if(e.type==="DEBUG_LOG"){const{message:n,args:t}=e.payload;console.log("[Tabemap BG]:",n,...t)}});function m(e,n){const t=document.querySelector(".tabemap-rating-badge");if(t)if(e){if(t.textContent=e.toFixed(2),t.className=`tabemap-rating-badge ${b(e)}`,n){const r=document.createElement("a");r.href=n,r.target="_blank",r.className=t.className,r.innerHTML=`
             <img src="${browser.runtime.getURL("icon.png")}" class="tabemap-rating-icon" onerror="this.style.display='none'">
             ${e.toFixed(2)}
          `,t.replaceWith(r)}}else t.textContent="N/A",t.classList.add("tabemap-rating-low")}function b(e){return e>=3.4?"tabemap-rating-high":e>=3.3?"tabemap-rating-mid":"tabemap-rating-low"}p.observe(document.body,{childList:!0,subtree:!0});
