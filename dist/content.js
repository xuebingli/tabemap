console.log("Tabemap: Content script loaded");let i=null;const p=new MutationObserver(t=>{b()});function b(){const t=document.querySelectorAll("h1");let n=null,e=null;for(const o of t){const a=o.textContent?.trim();if(a&&a!=="Results"&&a!=="Google Maps"&&a!=="Tabemap"&&o.offsetParent!==null){n=o,e=a;break}}if(!n||!e)return;const r=document.querySelectorAll("h2");let l=null,s=null;const u=/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/;for(const o of r){const a=o.querySelector("span");if(a&&a.textContent&&u.test(a.textContent)){l=a.textContent.trim(),s=a;break}if(o.textContent&&u.test(o.textContent)){l=o.textContent.trim(),s=o;break}}if(l&&(console.log("Found Japanese name:",l),e=l),i===e){m(s||n);return}console.log("Found place (final):",e),i=e;let c=null;const d=document.querySelector('button[aria-label^="Phone:"], button[aria-label^="電話:"]');if(d){const o=d.getAttribute("aria-label");if(o){const a=o.match(/(\d[\d-]+\d)/);a&&(c=a[1])}}console.log("Extracted phone:",c),browser.runtime.sendMessage({type:"FETCH_TABELOG",payload:{name:e,phone:c}}),m(s||n)}function m(t){const n=t.nextElementSibling;if(n&&n.classList.contains("tabemap-rating-container"))return;const e=document.createElement("div");e.className="tabemap-rating-container",e.innerHTML=`
        <span class="tabemap-rating-badge tabemap-rating-mid">
            Loading...
        </span>
    `,t.insertAdjacentElement("afterend",e)}browser.runtime.onMessage.addListener(t=>{if(t.type==="TABELOG_DATA"){const{rating:n,url:e,name:r}=t.payload;console.log("Received TABELOG_DATA:",t.payload),console.log("Current Identifier:",i),i===r?f(n,e):console.warn("Name mismatch, ignoring update.")}else if(t.type==="TABELOG_ERROR"){const{name:n,error:e}=t.payload;console.error("Tabemap Error:",e),i===n&&f(null,null)}else if(t.type==="DEBUG_LOG"){const{message:n,args:e}=t.payload;console.log("[Tabemap BG]:",n,...e)}});function f(t,n){const e=document.querySelector(".tabemap-rating-badge");if(e)if(t){if(e.textContent=t.toFixed(2),e.className=`tabemap-rating-badge ${g(t)}`,n){const r=document.createElement("a");r.href=n,r.target="_blank",r.className=e.className,r.innerHTML=`
             <img src="${browser.runtime.getURL("tabelog-logo.png")}" class="tabemap-rating-icon" onerror="this.style.display='none'">
             ${t.toFixed(2)}
          `,e.replaceWith(r)}}else e.textContent="N/A",e.classList.add("tabemap-rating-low")}function g(t){return t>=3.4?"tabemap-rating-high":t>=3.3?"tabemap-rating-mid":"tabemap-rating-low"}p.observe(document.body,{childList:!0,subtree:!0});
