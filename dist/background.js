function h(s){const r=/class="[^"]*list-rst__rst-name-target[^"]*"[^>]*href="([^"]*)"/i,l=s.match(r);if(!l)return null;const o=l[1],c=/class="[^"]*list-rst[^"]*"/i,n=s.search(c);if(n===-1)return{url:o,rating:null};const i=s.slice(n),u=/class="[^"]*(?:list-rst__rating-val|c-rating__val)[^"]*"[^>]*>([\d\.]+)<\/span>/i,t=i.match(u);let e=null;return t&&(e=parseFloat(t[1])),{url:o,rating:e}}function g(s){const r=/class="rdheader-rating__score-val"[^>]*>([\d\.]+)<\/span>/i,l=s.match(r);return l?parseFloat(l[1]):null}browser.runtime.onMessage.addListener((s,r,l)=>{if(s.type==="FETCH_TABELOG"){const{name:o,phone:c}=s.payload,n=(t,...e)=>{console.log(t,...e),r.tab?.id&&browser.tabs.sendMessage(r.tab.id,{type:"DEBUG_LOG",payload:{message:t,args:e}}).catch(()=>{})};n(`Searching Tabelog for: ${o} (Phone: ${c})`);const i=()=>{if(!c)return Promise.resolve(null);const t=`https://tabelog.com/rstLst/?sw=${encodeURIComponent(c)}`;return n(`phoneUrl: ${t}`),fetch(t).then(e=>e.text()).then(e=>{const a=h(e);return a&&a.url?(n("Phone match found:",a.url),a):null})},u=()=>{const t=`https://tabelog.com/rstLst/?sw==${encodeURIComponent(o)}`;return n(`nameUrl: ${t}`),fetch(t).then(e=>e.text()).then(e=>{const a=h(e);return a&&a.url?(n("Name match found:",a.url),a):null})};return i().then(t=>t||(n("Phone search failed, trying name..."),u())).then(t=>{if(!t)throw new Error("No results found");return t.rating?t:fetch(t.url).then(e=>e.text()).then(e=>({rating:g(e),url:t.url}))}).then(t=>{n("Sending data:",t),r.tab?.id&&browser.tabs.sendMessage(r.tab.id,{type:"TABELOG_DATA",payload:{...t,name:o}})}).catch(t=>{console.error("Tabelog fetch error:",t),r.tab?.id&&browser.tabs.sendMessage(r.tab.id,{type:"TABELOG_ERROR",payload:{name:o,error:t.message}})}),!0}});
